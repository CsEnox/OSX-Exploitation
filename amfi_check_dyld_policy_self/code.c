#include <stdio.h>
#include <unistd.h>
#include <string.h>

enum amfi_dyld_policy_output_flag_set {
AMFI_DYLD_OUTPUT_ALLOW_AT_PATH = (1 << 0),
AMFI_DYLD_OUTPUT_ALLOW_PATH_VARS = (1 << 1),
AMFI_DYLD_OUTPUT_ALLOW_CUSTOM_SHARED_CACHE = (1 << 2),
AMFI_DYLD_OUTPUT_ALLOW_FALLBACK_PATHS = (1 << 3),
AMFI_DYLD_OUTPUT_ALLOW_PRINT_VARS = (1 << 4),
AMFI_DYLD_OUTPUT_ALLOW_FAILED_LIBRARY_INSERTION = (1 << 5),
AMFI_DYLD_OUTPUT_ALLOW_LIBRARY_INTERPOSING = (1 << 6),
};

void printAmfiOutputFlags(int amfiOutputFlags) {
    int allowAtPaths = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_AT_PATH);
    int allowEnvVarsPrint = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_PRINT_VARS);
    int allowEnvVarsPath = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_PATH_VARS);
    int allowEnvVarsSharedCache = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_CUSTOM_SHARED_CACHE);
    int allowClassicFallbackPaths = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_FALLBACK_PATHS);
    int allowInsertFailures = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_FAILED_LIBRARY_INSERTION);
    int allowInterposing = (amfiOutputFlags & AMFI_DYLD_OUTPUT_ALLOW_LIBRARY_INTERPOSING);

    printf("AMFI Output Flags:\n");
    printf("Allow At Paths: %s\n", allowAtPaths ? "Enabled" : "Disabled");
    printf("Allow Print Env Vars: %s\n", allowEnvVarsPrint ? "Enabled" : "Disabled");
    printf("Allow Path Env Vars: %s\n", allowEnvVarsPath ? "Enabled" : "Disabled");
    printf("Allow Shared Cache Env Vars: %s\n", allowEnvVarsSharedCache ? "Enabled" : "Disabled");
    printf("Allow Classic Fallback Paths: %s\n", allowClassicFallbackPaths ? "Enabled" : "Disabled");
    printf("Allow Insert Failures: %s\n", allowInsertFailures ? "Enabled" : "Disabled");
    printf("Allow Interposing: %s\n", allowInterposing ? "Enabled" : "Disabled");
}


static unsigned long amfi_check_dyld_policy_self() {
    // Define a MAC policy and call value
    char policy[] = "AMFI";
    int call = 0x5a;

    // Define an argument array (arg2)
    unsigned char arg2[] = {0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa};

    // Get the memory address of arg2
    unsigned long arg2_address = (unsigned long)&arg2;

    // Declare a pointer (ptr) and set it to the address of arg2
    unsigned long *ptr = &arg2_address;

    // Set arg1_address to the address of the pointer (ptr)
    unsigned long arg1_address = (unsigned long)&ptr;

    // Invoke the syscall with the policy, call, arg1_address, and arg2_value
    int result = syscall(381, policy, call, arg1_address);

    if (result == -1) {
        // If syscall fails, print an error message and return 0
        perror("[!] MAC syscall failed");
        return 0;
    }
    else {
        // If syscall succeeds, print a success message and output flags
        printf("[!] MAC Syscall succeeded with result: %d\n", result);

        // Dereference arg2_address to get the value that it points to (i.e., the value at arg2_address)
        // Return this value from the function
        return *((unsigned long *)arg2_address);
    }
}

int main() {
    printf("Hello, Enox!\n");

    // Call the amfiSettings function and assign its return value (i.e., the value at arg2_address) to outputValue
    unsigned long amfiOutputFlags = amfi_check_dyld_policy_self();

    // Print the value at arg2_address
    printf("[+] Value at arg2_address: 0x%lx\n", amfiOutputFlags);

    // Calling function 
    printAmfiOutputFlags(amfiOutputFlags);

    return 0;
}
